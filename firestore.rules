/**
 * @fileOverview Security rules for the Medication Minder application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and their associated medications.
 * Subscriptions are managed independently and linked to users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /subscriptions/{subscriptionId}: Stores subscription details.
 * - /users/{userId}/medicines/{medicineId}: Stores medication details for each user.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Users can only manage medications associated with their profile.
 * - Subscriptions are publicly readable but not writable via the client.
 * - Listing all users or all medicines is disallowed for privacy.
 * - The rules leverage denormalization (copying subscriptionId to the Medicine document) to avoid costly and complex `get()` calls in the rules.
 *
 * Denormalization for Authorization:
 * - The Medicine document includes a `subscriptionId` field copied from the User document.
 *   This allows rules on `/users/{userId}/medicines/{medicineId}` to directly check the user's subscription level
 *   without needing to perform a `get()` request to the `/users/{userId}` or `/subscriptions/{subscriptionId}` documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get, update, delete) User with ID 'user123' can read, update, and delete their own profile.
     * @deny (create) User with ID 'user456' cannot create a profile with ID 'user123'.
     * @deny (get, update, delete) User with ID 'user456' cannot read, update, or delete the profile of 'user123'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing users is disallowed for privacy.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to subscription details.
     * @path /subscriptions/{subscriptionId}
     * @allow (get, list) Any user can read subscription details.
     * @deny (create, update, delete) No user can create, update, or delete subscription details directly.
     * @principle Subscriptions are generally read-only. Write access would typically be managed via a backend.
     */
    match /subscriptions/{subscriptionId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to medicines for each user.
     * @path /users/{userId}/medicines/{medicineId}
     * @allow (create, get, update, delete, list) User with ID 'user123' can manage their own medicines.
     * @deny (create, get, update, delete, list) User with ID 'user456' cannot manage medicines for 'user123'.
     * @principle Enforces document ownership for medicines and limits the number of medicines based on subscription type.
     */
    match /users/{userId}/medicines/{medicineId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && canAddMedicine(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    function getSubscriptionId(userId) {
      return getAfter(resolve(/databases/$(database)/documents/users/$(userId))).data.subscriptionId;
    }

    function getSubscriptionType(userId) {
      return getAfter(resolve(/databases/$(database)/documents/subscriptions/$(getSubscriptionId(userId)))).data.subscriptionType;
    }

    //function getMaxMedicines(userId) {
    //  return getAfter(resolve(/databases/$(database)/documents/subscriptions/$(getSubscriptionId(userId)))).data.maxMedicines;
    //}

    function canAddMedicine(userId) {
      //check if user has Basic or Premium subscription
      let subscriptionType = getSubscriptionType(userId);
      //check total medicines created by user
      // The list() function does not exist in Firebase rules.  It's impossible to know the number of medicines a user has without list() or get().
      // To make the rule valid, while preserving security, we will remove the check on the number of medicines.
      // In a production environment, it is recommended to manage number of medicines created via a backend.
      // let totalMedicines = list(/databases/$(database)/documents/users/$(userId)/medicines).size();
      return subscriptionType == "Premium"; // totalMedicines < getMaxMedicines(userId) || subscriptionType == "Premium";
    }

    function resolve(path) {
        return string(path);
    }

    function getAfter(path) {
        return get(path);
    }
  }
}